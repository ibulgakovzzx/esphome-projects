name: ðŸ­ Ð¡Ð±Ð¾Ñ€ÐºÐ° Ð¿Ñ€Ð¾ÑˆÐ¸Ð²ÐºÐ¸ ESPHome

on:
  push:
    branches: [ main ]
    paths:
      - 'jnge-wind-solar-controller.yaml'
  workflow_dispatch:      

jobs:
  build-firmware:
    runs-on: ubuntu-latest
    
    steps:
      # 1. Ð—Ð°Ð³Ñ€ÑƒÐ¶Ð°ÐµÐ¼ ÐºÐ¾Ð´
      - name: ðŸ“¥ ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ð¹
        uses: actions/checkout@v4
      
      # 2. ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼, Ñ‡Ñ‚Ð¾ jnge-wind-solar-controller.yaml ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÐµÑ‚
      - name: ðŸ” ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° ÐºÐ¾Ð½Ñ„Ð¸Ð³Ð°
        run: |
          if [ ! -f "jnge-wind-solar-controller.yaml" ]; then
            echo "âŒ ÐžÑˆÐ¸Ð±ÐºÐ°: Ñ„Ð°Ð¹Ð» jnge-wind-solar-controller.yaml Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½!"
            echo "Ð¡Ð¾Ð·Ð´Ð°Ð¹Ñ‚Ðµ jnge-wind-solar-controller.yaml Ñ ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸ÐµÐ¹ ESPHome"
            exit 1
          fi
          echo "âœ… jnge-wind-solar-controller.yaml Ð½Ð°Ð¹Ð´ÐµÐ½"
      
      # 3. Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Python
      - name: ðŸ Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      # 4. Ð¡Ñ‚Ð°Ð²Ð¸Ð¼ ESPHome
      - name: ðŸ“¦ Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ ESPHome
        run: pip install esphome
      
      # 5. Ð¡ÐµÐºÑ€ÐµÑ‚Ñ‹ (Ð¾Ð¿Ñ†Ð¸Ð¾Ð½Ð°Ð»ÑŒÐ½Ð¾)
      - name: ðŸ” ÐÐ°ÑÑ‚Ñ€Ð°Ð¸Ð²Ð°ÐµÐ¼ ÑÐµÐºÑ€ÐµÑ‚Ñ‹
        run: |
          if grep -q "!secret" "jnge-wind-solar-controller.yaml"; then
            echo "ðŸ” Ð¡Ð¾Ð·Ð´Ð°ÑŽ Ñ„Ð°Ð¹Ð» secrets.yaml"
            cat > secrets.yaml << 'EOF'
          wifi_ssid: "${{ secrets.WIFI_SSID }}"
          wifi_password: "${{ secrets.WIFI_PASSWORD }}"
          api_encryption_key: "${{ secrets.API_ENCRYPTION_KEY }}"
          ota_password: "${{ secrets.OTA_PASSWORD }}"
          EOF
            echo "âœ… Ð¡ÐµÐºÑ€ÐµÑ‚Ñ‹ Ð½Ð°ÑÑ‚Ñ€Ð¾ÐµÐ½Ñ‹"
          else
            echo "â„¹ï¸ Ð¡ÐµÐºÑ€ÐµÑ‚Ñ‹ Ð½Ðµ Ñ‚Ñ€ÐµÐ±ÑƒÑŽÑ‚ÑÑ"
          fi
      
      # 6. ÐšÐ¾Ð¼Ð¿Ð¸Ð»Ð¸Ñ€ÑƒÐµÐ¼
      - name: ðŸ› ï¸ ÐšÐ¾Ð¼Ð¿Ð¸Ð»Ð¸Ñ€ÑƒÐµÐ¼ Ð¿Ñ€Ð¾ÑˆÐ¸Ð²ÐºÑƒ
        run: esphome compile jnge-wind-solar-controller.yaml
      
      # 7. ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ Ð¸Ð¼Ñ ÑƒÑÑ‚Ñ€Ð¾Ð¹ÑÑ‚Ð²Ð°
      - name: ðŸ·ï¸ ÐžÐ¿Ñ€ÐµÐ´ÐµÐ»ÑÐµÐ¼ Ð¸Ð¼Ñ ÑƒÑÑ‚Ñ€Ð¾Ð¹ÑÑ‚Ð²Ð°
        id: get_device
        run: |
          # Ð˜Ð·Ð²Ð»ÐµÐºÐ°ÐµÐ¼ Ð¸Ð¼Ñ ÑƒÑÑ‚Ñ€Ð¾Ð¹ÑÑ‚Ð²Ð° Ð¸Ð· jnge-wind-solar-controller.yaml
          NAME=$(grep -m1 "^  name:" jnge-wind-solar-controller.yaml || grep -m1 "^name:" jnge-wind-solar-controller.yaml)
          DEVICE_NAME=$(echo "$NAME" | awk -F: '{print $2}' | tr -d ' "')
          
          if [ -z "$DEVICE_NAME" ]; then
            echo "âš ï¸ ÐÐµ Ð¼Ð¾Ð³Ñƒ Ð¾Ð¿Ñ€ÐµÐ´ÐµÐ»Ð¸Ñ‚ÑŒ Ð¸Ð¼Ñ ÑƒÑÑ‚Ñ€Ð¾Ð¹ÑÑ‚Ð²Ð°, Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÑŽ 'device'"
            DEVICE_NAME="device"
          fi
          
          echo "Ð˜Ð¼Ñ ÑƒÑÑ‚Ñ€Ð¾Ð¹ÑÑ‚Ð²Ð°: $DEVICE_NAME"
          echo "device_name=$DEVICE_NAME" >> $GITHUB_OUTPUT
      
      # 8. ÐšÐ¾Ð¿Ð¸Ñ€ÑƒÐµÐ¼ Ñ„Ð°Ð¹Ð»Ñ‹ Ñ Ð¿Ð¾Ð½ÑÑ‚Ð½Ñ‹Ð¼Ð¸ Ð¸Ð¼ÐµÐ½Ð°Ð¼Ð¸
      - name: ðŸ“‚ Ð“Ð¾Ñ‚Ð¾Ð²Ð¸Ð¼ Ñ„Ð°Ð¹Ð»Ñ‹ Ð´Ð»Ñ ÑÐºÐ°Ñ‡Ð¸Ð²Ð°Ð½Ð¸Ñ
        run: |
          DEVICE_NAME="${{ steps.get_device.outputs.device_name }}"
          
          echo "ðŸ“ ÐšÐ¾Ð¿Ð¸Ñ€ÑƒÑŽ Ñ„Ð°Ð¹Ð»Ñ‹ Ð¿Ñ€Ð¾ÑˆÐ¸Ð²ÐºÐ¸:"
          
          # firmware.bin â†’ firmware.bin
          cp ".esphome/build/$DEVICE_NAME/.pioenvs/$DEVICE_NAME/firmware.bin" "./firmware.bin"
          echo "âœ… firmware.bin Ð³Ð¾Ñ‚Ð¾Ð²"
          
          # firmware.factory.bin â†’ factory.bin
          cp ".esphome/build/$DEVICE_NAME/.pioenvs/$DEVICE_NAME/firmware.factory.bin" "./factory.bin"
          echo "âœ… factory.bin Ð³Ð¾Ñ‚Ð¾Ð²"
          
          # ÐŸÐ¾ÐºÐ°Ð·Ñ‹Ð²Ð°ÐµÐ¼ Ñ€Ð°Ð·Ð¼ÐµÑ€Ñ‹
          echo ""
          echo "ðŸ“Š Ð Ð°Ð·Ð¼ÐµÑ€Ñ‹ Ñ„Ð°Ð¹Ð»Ð¾Ð²:"
          ls -lh *.bin
      
      # 9. Ð¡Ð¾Ð·Ð´Ð°Ñ‘Ð¼ README Ñ„Ð°Ð¹Ð»
      - name: ðŸ“ Ð¡Ð¾Ð·Ð´Ð°Ñ‘Ð¼ README
        run: |
          DEVICE_NAME="${{ steps.get_device.outputs.device_name }}"
          
          cat > README.txt << EOF
          =========================================
          ÐŸÐ ÐžÐ¨Ð˜Ð’ÐšÐ ESPHome
          =========================================
          
          ðŸ“‹ Ð˜ÐÐ¤ÐžÐ ÐœÐÐ¦Ð˜Ð¯ Ðž Ð¡Ð‘ÐžÐ ÐšÐ•:
          
          Ð£ÑÑ‚Ñ€Ð¾Ð¹ÑÑ‚Ð²Ð¾: $DEVICE_NAME
          Ð”Ð°Ñ‚Ð° ÑÐ±Ð¾Ñ€ÐºÐ¸: $(date "+%Y-%m-%d %H:%M:%S")
          Ð’ÐµÑ€ÑÐ¸Ñ ESPHome: $(esphome version | head -1)
          
          =========================================
          ðŸ“ Ð¤ÐÐ™Ð›Ð« Ð’ ÐÐ Ð¥Ð˜Ð’Ð•:
          
          1. firmware.bin
             ÐÐ°Ð·Ð½Ð°Ñ‡ÐµÐ½Ð¸Ðµ: OTA-Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ (Ð¿Ð¾ Wi-Fi)
             ÐšÐ°Ðº Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÑŒ:
               â€¢ Ð£ÑÑ‚Ñ€Ð¾Ð¹ÑÑ‚Ð²Ð¾ Ð´Ð¾Ð»Ð¶Ð½Ð¾ Ð±Ñ‹Ñ‚ÑŒ Ð¿Ð¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¾ Ðº Wi-Fi
               â€¢ ÐžÑ‚ÐºÑ€Ð¾Ð¹Ñ‚Ðµ Ð²ÐµÐ±-Ð¸Ð½Ñ‚ÐµÑ€Ñ„ÐµÐ¹Ñ (http://IP-Ð°Ð´Ñ€ÐµÑ-ÑƒÑÑ‚Ñ€Ð¾Ð¹ÑÑ‚Ð²Ð°)
               â€¢ ÐŸÐµÑ€ÐµÐ¹Ð´Ð¸Ñ‚Ðµ Ð² Ñ€Ð°Ð·Ð´ÐµÐ» "ÐžÐ±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ"
               â€¢ Ð—Ð°Ð³Ñ€ÑƒÐ·Ð¸Ñ‚Ðµ ÑÑ‚Ð¾Ñ‚ Ñ„Ð°Ð¹Ð»
          
          2. factory.bin
             ÐÐ°Ð·Ð½Ð°Ñ‡ÐµÐ½Ð¸Ðµ: ÐŸÐµÑ€Ð²Ð¸Ñ‡Ð½Ð°Ñ Ð¿Ñ€Ð¾ÑˆÐ¸Ð²ÐºÐ° (Ñ‡ÐµÑ€ÐµÐ· USB)
             ÐšÐ°Ðº Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÑŒ:
               â€¢ ÐŸÐ¾Ð´ÐºÐ»ÑŽÑ‡Ð¸Ñ‚Ðµ ESP Ðº ÐºÐ¾Ð¼Ð¿ÑŒÑŽÑ‚ÐµÑ€Ñƒ Ñ‡ÐµÑ€ÐµÐ· USB-UART Ð°Ð´Ð°Ð¿Ñ‚ÐµÑ€
               â€¢ Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹Ñ‚Ðµ esptool.py Ð¸Ð»Ð¸ Flash Download Tool
               â€¢ Ð—Ð°Ð³Ñ€ÑƒÐ·Ð¸Ñ‚Ðµ Ñ„Ð°Ð¹Ð» Ð¿Ð¾ Ð°Ð´Ñ€ÐµÑÑƒ 0x0
          
          =========================================
          âš™ï¸ ÐšÐžÐÐ¤Ð˜Ð“Ð£Ð ÐÐ¦Ð˜Ð¯ Ð£Ð¡Ð¢Ð ÐžÐ™Ð¡Ð¢Ð’Ð:
          
          ÐŸÐ»Ð°Ñ‚Ñ„Ð¾Ñ€Ð¼Ð°: $(grep -m1 "platform:" jnge-wind-solar-controller.yaml || echo "ÐÐµ ÑƒÐºÐ°Ð·Ð°Ð½Ð°")
          ÐŸÐ»Ð°Ñ‚Ð°: $(grep -m1 "board:" jnge-wind-solar-controller.yaml | sed 's/.*://' | tr -d ' "')
          
          =========================================
          â“ ÐŸÐžÐœÐžÐ©Ð¬:
          
          â€¢ ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸ Ð¿Ñ€Ð¾ÑˆÐ¸Ð²ÐºÐµ: Ð¿Ñ€Ð¾Ð²ÐµÑ€ÑŒÑ‚Ðµ Ð¿Ð¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ðµ Ð¸ Ð²Ñ‹Ð±Ñ€Ð°Ð½Ð½Ñ‹Ð¹ Ð¿Ð¾Ñ€Ñ‚
          â€¢ Ð£ÑÑ‚Ñ€Ð¾Ð¹ÑÑ‚Ð²Ð¾ Ð½Ðµ Ð¿Ð¾Ð´ÐºÐ»ÑŽÑ‡Ð°ÐµÑ‚ÑÑ Ðº Wi-Fi: Ð¿Ñ€Ð¾Ð²ÐµÑ€ÑŒÑ‚Ðµ Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ¸ Ð² jnge-wind-solar-controller.yaml
          â€¢ ÐÑƒÐ¶Ð½Ð° Ð½Ð¾Ð²Ð°Ñ Ð¿Ñ€Ð¾ÑˆÐ¸Ð²ÐºÐ°: Ð¸Ð·Ð¼ÐµÐ½Ð¸Ñ‚Ðµ jnge-wind-solar-controller.yaml Ð¸ Ð·Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚Ðµ ÑÐ±Ð¾Ñ€ÐºÑƒ Ð·Ð°Ð½Ð¾Ð²Ð¾
          
          =========================================
          EOF
          
          echo "âœ… README.txt ÑÐ¾Ð·Ð´Ð°Ð½"
          echo ""
          echo "ðŸ“„ Ð¡Ð¾Ð´ÐµÑ€Ð¶Ð¸Ð¼Ð¾Ðµ README:"
          cat README.txt
      
      # 10. Ð—Ð°Ð³Ñ€ÑƒÐ¶Ð°ÐµÐ¼ Ð² Artifacts
      - name: ðŸ“¤ Ð—Ð°Ð³Ñ€ÑƒÐ¶Ð°ÐµÐ¼ Ð¿Ñ€Ð¾ÑˆÐ¸Ð²ÐºÑƒ Ñ Ð´Ð¾ÐºÑƒÐ¼ÐµÐ½Ñ‚Ð°Ñ†Ð¸ÐµÐ¹
        uses: actions/upload-artifact@v4
        with:
          name: firmware-package
          path: |
            firmware.bin
            factory.bin
            README.txt
          retention-days: 7
